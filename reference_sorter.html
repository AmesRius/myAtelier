<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APA参考文献ソート</title>
    <!-- Tailwind CSS CDNをロード -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスクロールバー */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 4px; }
        textarea::-webkit-scrollbar-track { background: #f3f4f6; }

        /* スタイリッシュなフォント設定 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }

        /* 視覚的な階層を強調するためのフォーカススタイル */
        .input-focus:focus {
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5', // Indigo 600
                        'accent-red': '#ef4444', // Red 500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-10 antialiased">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 mb-2 tracking-tight">
                APA文献リスト ソートメーカー
            </h1>
            <p class="text-gray-500 text-lg">著者名のフリガナ指定による確実な五十音/アルファベット順並び替え</p>
        </header>

        <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-2xl border border-gray-200">
            
            <!-- 説明ボックス - 注意点 -->
            <div class="bg-red-50 border-2 border-accent-red/50 text-red-800 p-4 sm:p-5 mb-6 rounded-xl">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-3 text-accent-red" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <p class="font-bold text-xl">重要なお願い：読み仮名のルール</p>
                </div>
                <ul class="list-disc list-inside text-sm mt-3 ml-2 space-y-1">
                    <li>日本語の文献は、行頭に[ヨミガナ]を付けてください。</li>
                    <li>五十音順を選択する場合：読み仮名にはカタカナを使用してください。（例：[イシモト]）</li>
                    <li>アルファベット順を選択する場合：読み仮名にはローマ字を使用してください。（例：[ISHIMOTO]）</li>
                </ul>
            </div>
            
            <div class="flex flex-col lg:flex-row lg:space-x-8">
                
                <!-- 入力エリア -->
                <div class="flex-1 mb-8 lg:mb-0">
                    <label for="input-references" class="block text-xl font-bold text-gray-700 mb-3">
                        <span class="text-primary-blue mr-2">1.</span> 参考文献を貼り付け
                    </label>
                    <textarea id="input-references" rows="12" class="w-full p-4 border-2 border-gray-300 rounded-xl input-focus focus:border-primary-blue transition duration-200 shadow-md" placeholder="例:&#10;[ヤマダ]or[YAMADA]山田 花子. (2022). 研究者の倫理. 学会誌C.&#10;Smith, J. (2018). Advanced Writing. Journal B."></textarea>
                </div>

                <!-- 操作エリア (選択と実行) -->
                <div class="flex-1">
                    <label for="sort-method" class="block text-xl font-bold text-gray-700 mb-3">
                        <span class="text-primary-blue mr-2">2.</span> 並び替え方法を選択
                    </label>
                    <select id="sort-method" class="w-full p-4 border-2 border-gray-300 rounded-xl input-focus focus:border-primary-blue transition duration-200 shadow-md mb-6 bg-white text-gray-800 appearance-none">
                        <option value="ja">五十音順 (日本語：カタカナのフリガナでソート)</option>
                        <option value="en">アルファベット順 (日本語：ローマ字の読み仮名でソート)</option>
                    </select>

                    <button onclick="sortReferences()" class="w-full py-4 text-xl font-extrabold text-white bg-primary-blue hover:bg-indigo-700 rounded-xl shadow-lg transform transition duration-200 hover:scale-[1.01] active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-primary-blue/50 mb-6">
                        並び替えを実行
                    </button>
                    
                    <!-- 出力エリア -->
                    <label for="output-references" class="block text-xl font-bold text-gray-700 mb-3">
                        <span class="text-primary-blue mr-2">3.</span> ソート結果
                    </label>
                    <textarea id="output-references" rows="12" readonly class="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 text-gray-800 resize-none shadow-inner"></textarea>
                </div>
            </div>

            <!-- アクションボタン (横並び) -->
            <div class="flex justify-end mt-6"> 
                <button id="copy-button" onclick="copyToClipboard()" class="py-3 px-8 text-lg font-bold text-primary-blue bg-indigo-100 hover:bg-indigo-200 rounded-full shadow-md transform transition duration-200 hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-opacity-50">
                    結果をコピー
                </button>
            </div>
            
            <!-- メッセージ表示エリア -->
            <div id="message-box" class="mt-4 text-center text-sm font-medium h-6"></div>
        </div>
    </div>

    <script>
        /**
         * 参考文献リストを取得し、フリガナをキーとしてソートして出力エリアに表示します。
         */
        function sortReferences() {
            const inputEl = document.getElementById('input-references');
            const outputEl = document.getElementById('output-references');
            const messageEl = document.getElementById('message-box');
            const sortMethod = document.getElementById('sort-method').value; // 'ja' or 'en'
            
            const rawText = inputEl.value;

            // 1. テキストを行ごとに分割し、空行を削除
            let references = rawText.split('\n')
                                    .map(line => line.trim())
                                    .filter(line => line.length > 0);

            if (references.length === 0) {
                showMessage('入力エリアに参考文献がありません。', 'error');
                outputEl.value = '';
                return;
            }

            // 2. ソートキーを抽出
            let processedReferences = references.map(line => {
                let key = line;
                let original = line;
                
                // 行頭の [フリガナ] パターンを検出する正規表現
                const match = line.match(/^\[(.+?)\]\s*(.*)$/);
                
                if (match) {
                    // フリガナ/ローマ字が見つかった場合
                    const sortBase = match[1].toUpperCase();
                    // keyは [読み仮名] + 残りの文献データ となる
                    key = sortBase + match[2]; 
                    // originalはフリガナを削除した部分 (出力として使用)
                    original = match[2].trim(); 
                }
                
                return {
                    original: original,
                    key: key
                };
            });

            // 3. 辞書順でソート（選択されたロケールでソートを切り替える）
            processedReferences.sort((a, b) => {
                // 'en' (アルファベット順) の場合、日本語と英語が混在したキーでもアルファベットの並びを優先する
                // 'ja' (五十音順) の場合、日本語のルール（カタカナのフリガナ）を優先する
                return a.key.localeCompare(b.key, sortMethod, { sensitivity: 'base' });
            });

            // 4. ソートされたリストを結合 (originalフィールドを使用するためフリガナは削除される)
            const sortedText = processedReferences.map(item => item.original).join('\n');

            // 5. 結果を出力エリアに表示
            outputEl.value = sortedText;
            
            const sortMessage = sortMethod === 'ja' 
                                ? '五十音順に並び替えられました。' 
                                : 'アルファベット順に並び替えられました。';
            
            showMessage(`ソートが完了しました。${references.length}件の参考文献が${sortMessage}`, 'success');
        }

        /**
         * ソートされたテキストをクリップボードにコピーします。
         */
        function copyToClipboard() {
            const outputEl = document.getElementById('output-references');
            const messageEl = document.getElementById('message-box');
            
            if (outputEl.value.trim() === '') {
                showMessage('コピーするソート結果がありません。', 'error');
                return;
            }

            // クリップボードAPIを使用
            navigator.clipboard.writeText(outputEl.value)
                .then(() => {
                    showMessage('ソート結果をクリップボードにコピーしました！', 'success');
                })
                .catch(err => {
                    // Fallback for environments where clipboard API is restricted
                    outputEl.select();
                    try {
                        document.execCommand('copy');
                        showMessage('ソート結果をクリップボードにコピーしました！', 'success');
                    } catch (e) {
                        console.error('Copy failed:', e);
                        showMessage('コピーに失敗しました。手動でコピーしてください。', 'error');
                    }
                });
        }
        
        /**
         * ユーザーメッセージを表示します。
         */
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message-box');
            messageEl.textContent = text;
            
            // クラスをリセット
            messageEl.className = 'mt-4 text-center text-sm font-medium h-6';

            if (type === 'success') {
                messageEl.classList.add('text-green-600', 'font-semibold');
            } else if (type === 'error') {
                messageEl.classList.add('text-red-600', 'font-semibold');
            } else {
                messageEl.classList.add('text-gray-500');
            }

            // 3秒後にメッセージをクリア
            setTimeout(() => {
                if (messageEl.textContent === text) {
                     messageEl.textContent = '';
                }
            }, 3000);
        }
    </script>
</body>
</html>
